<link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    rel="stylesheet"
/>

<script type="text/javascript" ;>
    const componentIcons = {
        button: "fa-solid fa-diagram-predecessor",
        anchor: "fa-solid fa-link",
        buttongroup: "fa-solid fa-layer-group",
        icon: "fa-solid fa-icons",
        search: "fa-solid fa-magnifying-glass",
        tooltip: "fa-solid fa-circle-info",
        video: "fa-solid fa-video",
        checkbox: "fa-solid fa-square-check",
        picture: "fa-solid fa-image",
        calendar: "fa-solid fa-calendar-days",
        currency: "fa-solid fa-dollar-sign",
        fileupload: "fa-solid fa-file-upload",
        radioset: "fa-solid fa-circle-dot",
        rating: "fa-solid fa-star",
        time: "fa-solid fa-clock",
        toggle: "fa-solid fa-toggle-on",
        spinner: "fa-solid fa-spinner",
        progressbar: "fa-solid fa-bars-progress",
        progresscircle: "fa-solid fa-circle-notch",
        label: "fa-solid fa-font",
        list: "fa-solid fa-list",
        text: "fa-solid fa-text-width",
        textarea: "fa-solid fa-align-left",
        table: "fa-solid fa-table",
        tab: "fa-solid fa-folder",
        card: "fa-solid fa-id-card",
        chart: "fa-solid fa-chart-pie",
        panel: "fa-solid fa-columns",
        breadcrumb: "fa-solid fa-ellipsis-h",
        accordion: "fa-solid fa-bars-staggered",
        carousel: "fa-solid fa-sliders-h",
        tree: "fa-solid fa-tree",
        map: "fa-solid fa-map",
        slider: "fa-solid fa-sliders",
    };

    document.addEventListener("DOMContentLoaded", () => {
        // Function to replace SVGs with FontAwesome icons
        const replaceSVGs = () => {
            const sidebarItems = document.querySelectorAll(
                '[data-nodetype="component"]:not(.icon-replaced)'
            );

            sidebarItems.forEach((sidebarItem) => {
                sidebarItem.classList.add("icon-replaced");
                const svgElement =
                    sidebarItem.querySelector("button > div > svg");
                if (svgElement) {
                    svgElement.remove();
                }

                const name = sidebarItem
                    .getAttribute("data-item-id")
                    ?.split("-")[1];
                const iconClass =
                    componentIcons[name] || "fa-solid fa-border-all";

                const newIcon = document.createElement("i");
                newIcon.className = `fas ${iconClass}`;
                newIcon.classList.add("css-1e3avu6");

                const target = sidebarItem.querySelector("button > div");
                if (target) {
                    target.prepend(newIcon);
                }
            });
        };

        // Function to handle auto-collapse logic
        const setupAutoCollapse = () => {
            const sidebarItems = document.querySelectorAll(
                '[data-nodetype="component"]:not(.listener-added)'
            );

            // Keep track of the currently open item
            let currentOpenItem = null;

            // Find initially open item
            sidebarItems.forEach((item) => {
                if (item.querySelector('button[aria-expanded="true"]')) {
                    currentOpenItem = item;
                }
            });

            sidebarItems.forEach((item) => {
                item.classList.add("listener-added");
                item.addEventListener("click", (event) => {
                    const button = item.querySelector("button");
                    const isExpanded =
                        button?.getAttribute("aria-expanded") === "true";
                    // If clicking the same item that's already open, let Storybook handle it
                    if (currentOpenItem === item) {
                        currentOpenItem = null;
                        return;
                    }

                    // Close the previously open item if it exists
                    if (currentOpenItem) {
                        const prevButton =
                            currentOpenItem.querySelector("button");
                        if (prevButton) {
                            prevButton.click();
                        }
                    }

                    if (!isExpanded) {
                        currentOpenItem = item;
                    }
                });
            });
        };

        // MutationObserver to monitor when the sidebar is added/updated
        const observer = new MutationObserver((mutationsList) => {
            for (const mutation of mutationsList) {
                if (mutation.type === "childList") {
                    const sidebar =
                        document.querySelector(".sidebar-container");
                    if (sidebar) {
                        replaceSVGs(); // Replace SVGs
                        setupAutoCollapse(); // Setup auto-collapse logic
                    }
                }
            }
        });

        // Start observing the DOM for sidebar injection
        observer.observe(document.body, { childList: true, subtree: true });
    });
</script>
